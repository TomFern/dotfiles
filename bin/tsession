#!/bin/bash
#
# attach a tmux session
#

# testing byobu
# xterminal -e "byobu"
byobu
exit $?


exec 2>&1
exec 2>/tmp/pablo

PROFILEDIR=$HOME/.tmux

function usage() {
cat <<EOF
usage:
    $0 [-S name]

options:
    -S name     attach or create session name
            When no session is supplied, attach to first numbered session. 
            If none exists, create one.

            When session name is supplied, attach if exists.
            Otherwise try to source matching file from ~/.tmux/

options:
EOF
}

session_name=
while getopts ":S:h" o; do
  case $o in
    S)
        session_name=$OPTARG
        ;;
    h)
        usage
        exit 0
        ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      exit 1
      ;;
    :)
      echo "Option -$OPTARG requires an argument." >&2
      exit 1
      ;;
    esac
done
shift $((OPTIND-1))

# when arg not def. use first existing 'numbered' session
if [ -z "$session_name" ]; then
    session_name=$(tmux list-sessions | grep -v attached | egrep '^[0-9]' | sort | head -n 1 | cut -d: -f1)
fi

if [ -z "$session_name" ]; then
    # no numbered session exists
    echo "opening new session"
    if [[ $(tty) =~ ^/dev/pts ]] || [ -z "$DISPLAY" ]; then
        tmux new-session
    else
        xterminal -t $session_name -e "tmux new-session"
    fi
elif tmux has -t $session_name 2>/dev/null; then
    # attach existing session
    echo "attaching to $session_name"
    if [[ $(tty) =~ ^/dev/pts ]] || [ -z "$DISPLAY" ]; then
        tmux attach -t "$session_name"
    else
        xterminal -t $session_name -e "tmux attach -t $session_name"
    fi
else
    # create a new session from file
    fn=
    if [ -f "$PROFILEDIR/$session_name" ]; then
        fn=$PROFILEDIR/$session_name
    else
        echo "file not found: $PROFILEDIR/$session_name"
        exit 1
    fi

    echo "sourcing file: $fn"
    if [[ $(tty) =~ ^/dev/pts ]] || [ -z "$DISPLAY" ]; then
        # tmux new -s $session_name -n $session_name "tmux source-file $fn"
        tmux source-file "$fn"
    else
        # xterminal -t $session_name -e "tmux new -s $session_name -n $session_name \"tmux source-file $fn\""
        xterminal -e "tmux source-file \"$fn\""
    fi
fi

