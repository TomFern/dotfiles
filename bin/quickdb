#!/usr/bin/env bash

function usage () {
    echo "Usage :  $0 -e PRODUCT -d DB -u USER -p PASSWORD
    Start a temporary test db

    Options:
        -e            Type of db (postgres, mysql)
        -d            DB name (demodb)
        -u            Username to create (demouser)
        -p            Password for the user (demouser)
        -h|help       Display this message
    "
}

SW_d=
SW_u=
SW_p=
SW_e=postgres
while getopts ":e:u:d:p:h" opt
do
  case $opt in
      e) SW_e=$OPTARG;;
      u) SW_u=$OPTARG;;
      d) SW_d=$OPTARG;;
      p) SW_p=$OPTARG;;
      h|help     )  usage; exit 0   ;;
      * )  echo -e "\n  Option does not exist : $opt\n"
          usage; exit 1   ;;
  esac
done
shift $(($OPTIND-1))
OTHERARGS=$@


case "$SW_e" in
    mysql)
        echo ":: Starting local mysql..."
        s=$(docker inspect -f '{{.State.Running}}' quickdb-mysql)
        if [[ "$s" != "true" ]]; then
            docker run -it -d --rm --name quickdb-mysql -p 3306:3306 -e MYSQL_ALLOW_EMPTY_PASSWORD=yes mysql --default_authentication_plugin=mysql_native_password mysql
            sleep 10
        fi

        if [ "x$SW_d" != "x" ]; then
            docker exec -it quickdb-mysql -- mysql -u root -ANe"CREATE SCHEMA $SW_d;"
        fi

        if [ "x$SW_u" != "x" ] && [ "x$SW_p" != "x" ]; then
            docker exec -it quickdb-mysql -- mysql -u root -ANe"CREATE USER '$SW_u'@'%' IDENTIFIED BY '$SW_p';"
            docker exec -it quickdb-mysql -- mysql -u root -ANe"GRANT ALL PRIVILEGES ON *.* TO '$SW_u'@'%';"
        fi
        ;;
    postgres|psql)
        echo ":: Starting PostgreSQL..."
        s=$(docker inspect -f '{{.State.Running}}' quickdb-postgres 2>/dev/null)
        if [[ "$s" != "true" ]]; then
            docker run -it -d --rm --name quickdb-postgres -p 5432:5432 -e POSTGRES_HOST_AUTH_METHOD=trust postgres
            sleep 10
        fi
        ;;
    *)
        echo "Type $SW_e not supported, sorry"
        exit 1
        ;;
esac
