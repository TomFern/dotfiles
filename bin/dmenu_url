#!/bin/bash

URLDIR=$HOME/.url

function usage() {
cat <<EOF
a dmenu for url bookmarks, opens browser or prints url

usage:
    $0 [-t name] [-p] [-s] [-b browser]

options:
    [-s] set active url file
    [-p] just print the url, don't open anything
    [-b browser] force browser command line
    [-t name] name of the url file to use

browser selection:
    1. string after ++ in selection. eg: example.com ++ firefox -P tom
    2. -b option. eg: dmenu_url -b "firefox -P tom"
    3. environment BROWSER variable

url file selection:
    1. -t option. eg: dmenu_url -t myown.urls
    2. -s switch sets active url file. eg: dmenu_url -s
    3. use active url file. eg. default.urls
EOF
}

# process arguments
file_change=
file_choose=
file_use="$URLDIR/default.urls"
GO=1
while getopts ":t:pb:sh" o; do
    case "${o}" in
        s)
            file_change=1
            ;;
        t)
            file_choose=${OPTARG}
            ;;
        b)
            BROWSER=${OPTARG}
            ;;
        p)
            GO=
            ;;
        h)
            usage
            exit 0
            ;;
    esac
done
shift $((OPTIND-1))

# 3 ways of choosing file to open:
#
# 1. -t file.urls -> $URLDIR/file.urls
# 2. -s (dmenu selection) -> $URLDIR/file.urls (remember option)
# 3. (no switch) -> default to $URLDIR/default.urls (link)
#

if [ -n "$file_change" ]; then
    file_use=$(ls -1 "$URLDIR"/*.urls | dmenu -p "url file: ")
    ln -s -f "$file_use" "$URLDIR/default.urls"
fi

if [ -n "$file_choose" ]; then
    file_use="$URLDIR/$file_choose"
fi

if [ -z "$file_use" ]; then
    echo default to bookmarks
    file_use='bookmarks.urls'
fi

if [ ! -f $file_use ]; then
    echo "file not found" >&2
    exit 1
fi

DMENU="dmenu -p "$(basename `realpath "$file_use"`)": "

# special treatment for *temps*.urls
# 1. Remove line after opening url
# 2. Invert file order per line

if [[ $file_use =~ .*temps.*\.urls ]]; then
    # goto=$(tac "$file_use" | dmenu | cut -d ' ' -f 1)
    selection=$(tac "$file_use" | dmenu)
else
    selection=$(dmenu < "$file_use")
fi
goto=$(echo "$selection"| cut -d ' ' -f 1)
selection_browser=$(echo "$selection" | sed -n -e 's/^.*++ //p')
if [ -n "$selection_browser" ]; then
    BROWSER=$selection_browser
fi

if [ -n "$goto" ]; then
    # delete temporary bookmarks once returned
    if [[ "$file_use" =~ .*temps.*\.urls ]]; then
        sed -i -e "\<^${goto}<d" $file_use
    fi

    if [ -n "$GO" ]; then
        $BROWSER ${goto}
    else
        echo $goto
    fi
    exit 0
else
    exit 0
fi
