<?php
/**
 * CakePHP(tm) : Rapid Development Framework (https://cakephp.org)
 * Copyright (c) Cake Software Foundation, Inc. (https://cakefoundation.org)
 *
 * Licensed under The MIT License
 * For full copyright and license information, please see the LICENSE.txt
 * Redistributions of files must retain the above copyright notice.
 *
 * @copyright     Copyright (c) Cake Software Foundation, Inc. (https://cakefoundation.org)
 * @link          https://cakephp.org CakePHP(tm) Project
 * @since         0.10.0
 * @license       https://opensource.org/licenses/mit-license.php MIT License
 */

use Cake\Cache\Cache;
use Cake\Core\Configure;
use Cake\Core\Plugin;
use Cake\Datasource\ConnectionManager;
use Cake\Error\Debugger;
use Cake\Http\Exception\NotFoundException;

$this->layout = 'home';
$title = "Provisioning";
$this->set('title', "Provisioning");

if (!Configure::read('debug')) :
    throw new NotFoundException(
        'Please replace src/Template/Pages/home.ctp with your own version or re-enable debug mode.'
    );
endif;
?>

<script>
function enable_inputs(ids) {
    for(i=0;i<ids.length;i++) {
        document.getElementById(ids[i]).disabled=false;
    }
}
function show_elements(ids) {
    for(i=0;i<ids.length;i++) {
        document.getElementById(ids[i]).style.visibility = "visible";
    }
}
function hide_elements(ids) {
    for(i=0;i<ids.length;i++) {
        document.getElementById(ids[i]).style.visibility = "hidden";
    }
}
</script>

<style>
.hidden {
    visibility: hidden;
}
</style>

<nav class="large-3 medium-4 columns" id="actions-sidebar">
    <ul class="side-nav">
        <li>Accounts</li>
        <li><?  = $this->Html->link('Accounts', ['controller' => 'Users', 'action'=>'index']) ?></li>
        <li>Provisioning</li>
        <li>Users</li>
        <li><?= $this->Html->link(__('New Phone'), ['action' => 'add']) ?></li>
        <li><?= $this->Html->link(__('List Accounts'), ['controller' => 'Accounts', 'action' => 'index']) ?></li>
        <li><?= $this->Html->link(__('New Account'), ['controller' => 'Accounts', 'action' => 'add']) ?></li>
        <li><?= $this->Html->link(__('List Brandmodels'), ['controller' => 'Brandmodels', 'action' => 'index']) ?></li>
        <li><?= $this->Html->link(__('New Brandmodel'), ['controller' => 'Brandmodels', 'action' => 'add']) ?></li>
        <li><?= $this->Html->link(__('List Registrations'), ['controller' => 'Registrations', 'action' => 'index']) ?></li>
        <li><?= $this->Html->link(__('New Registration'), ['controller' => 'Registrations', 'action' => 'add']) ?></li>
    </ul>
</nav>

<?php // provisioned devices
?>
<div class="widget">
<fieldset>

<?php /*
    <legend><h5>Devices</h5></legend>
    */
?>

    <div style="text-align: right; margin-right: 1rem;">
    <?= $this->Html->link('Add new phone', ['controller'=>'pages','action'=>'provisioner']) ?>
    </div>

    <?php if ($phone_count == 0): ?>
        No phones provisioned yet.
    <?php else : ?>

    <table cellpadding="0" cellspacing="0">
        <thead>
            <tr>
            <th scope="col"><?= $this->Paginator->sort('brandmodel_id') ?></th>
            <th scope="col"><?= $this->Paginator->sort('mac') ?></th>
            <th scope="col">Registrations</th>
            <th scope="col" class="actions"><?= __('Actions') ?></th>
            </tr>
        </thead>

        <tbody>
            <?php foreach ($phones as $phone): ?>
                <tr>
                    <td>
                        <a href="?view_phone=<?= h($phone->id)?>">
                        <?= h($phone->brandmodel->friendly_name) ?>
                        </a>
                    </td>
                    <td>
                        <a href="?view_phone=<?= h($phone->id)?>">
                        MAC: <?= h($phone->mac) ?>
                        </a>
                    </td>
                    <td>
                        <a href="?view_phone=<?= h($phone->id)?>">
                        <?= h($phone->registrations_set) ?>
                        </a>
                    </td>
                    <td class="actions">
                        <a href="?view_phone=<?= h($phone->id)?>">View</a>&nbsp; &nbsp;
                        <?= $this->Form->postLink(__('Delete'), ['controller'=>'pages','action'=>'deletePhone'], ['data' => ['phone_id' => $phone['id']], 'confirm' => 'Are you sure you want to phone MAC: '.$phone->mac.'?']) ?>

                    </td>
            </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
    <div class="paginator">
        <ul class="pagination">
            <?= $this->Paginator->first('<< ' . __('first')) ?>
            <?= $this->Paginator->prev('< ' . __('previous')) ?>
            <?= $this->Paginator->numbers() ?>
            <?= $this->Paginator->next(__('next') . ' >') ?>
            <?= $this->Paginator->last(__('last') . ' >>') ?>
        </ul>
    </div>
<?php endif; ?>
</fieldset>
</div>

<?php
  /****  new/edit phone form ***/
 ?>
<?php if($homepage['form_new_phone']): ?>
    <div class="widget-half">
    <?php echo $this->Form->create($view_phone, ['url' => ['action' => 'submit_phone']]) ?>
        <fieldset>
            <legend>Phone</legend>
            <?php
              $brands = array_keys($brandmodels_nested);
              echo $this->Form->control('brand', ['options' => $brands, 'id'=>'brand', 'default' => $brand_selected, 'disabled'=>$homepage['form_new_phone_ro']]);
              echo $this->Form->control('model', ['options' => $models, 'id'=>'brandmodel_id', 'name'=>'brandmodel_id', 'default' => $brandmodel_id_selected, 'disabled'=>$homepage['form_new_phone_ro']]);
            ?>
            <?php
                echo $this->Form->hidden('__form', ['default' => 'new_phone']);
                echo $this->Form->hidden('phone_id', ['default' => $view_phone['id']]);
                // echo $this->Form->control('account_id', ['options' => $accounts,'disabled'=>$homepage['form_new_phone_ro']]);
                // echo $this->Form->control('brandmodel_id', ['options' => $brandmodels,'disabled'=>$homepage['form_new_phone_ro']]);
                echo $this->Form->control('timezone_id', ['options' => $timezones,'disabled'=>$homepage['form_new_phone_ro']]);
                echo $this->Form->control('mac', ['disabled'=>$homepage['form_new_phone_ro'], 'label'=>'MAC Address', 'minLength'=>12, 'maxLength'=>12]);
            ?>
        </fieldset>
        <?php $submit_button_class = '';
            if($homepage['form_new_phone_ro']):
                $submit_button_class='hidden';
            endif ?>

        <div class="button-container">
            <?php $save_button_name = "Create";
                  if($homepage['form_new_phone_ro']):
                     $save_button_name = "Save";
                     endif
                     ?>
            <?= $this->Form->button($save_button_name, ['disabled'=>$homepage['form_new_phone_ro'], 'class'=> $submit_button_class, 'id' => 'Submit_Phone']) ?>
            <?php if($homepage['form_new_phone_ro']): ?>
            <a href="#" style="margin-right:2rem;" id="Edit_Phone" onclick="hide_elements(['Edit_Phone']); show_elements(['Submit_Phone']); enable_inputs(['mac','timezone-id','brandmodel_id','brand','Submit_Phone']);">Edit</a>
            <?= $this->Html->link('Cancel',['controller'=>'pages','action'=>'provisioner']) ?>
            <?php endif ?>
        </div>
        <?= $this->Form->end() ?>
    </div>
<?php endif; ?>

  <script>

  function update_models() {
      var brand = $('#brand option:selected').text();
      var option = null;

<?php
foreach(array_keys($brandmodels_nested) as $brand):
?>

if(brand == "<?= $brand ?>") {

      $('#brandmodel_id').empty();
<?php
foreach($brandmodels_nested[$brand] as $bm):

$bm_id = $bm['id'];
$bm_name = $bm['friendly_name'];

?>
      option = $('<option></option>').attr("value", "<?= $bm_id ?>").text("<?= $bm_name ?>");
      $('#brandmodel_id').append(option);


<?php endforeach ?>
}
<?php endforeach ?>
    }
  $('#brand').change(update_models);

<?php if(false): ?>
(function($) {
    $(document).ready(update_models);
})(jQuery);
<?php endif ?>

</script>

<?php // view phone widgets
          ?>
<?php if($homepage['view_phone']): ?>
    <div class="widget-half">
    <fieldset>
    <legend>Provision info</legend>
    <ul>
    <li> URL:
        <?php if(is_null($provisioner_info_url)):?>
            No provisioned
        <?php else: ?>
            <a href="<?=$provisioner_info_url?>"><?= $provisioner_info_url ?></a>
        <?php endif ?>
    </li>
    <li> Logs:
        <?php if($provisioner_info_logs_count == 0):?>
            No logs
        <?php else: ?>
        <?php foreach($provisioner_info_logs as $fn): ?>
            <a href="<?= $provisioner_info_url.'/'.$fn['filename']?>"><?= $fn['filename'] ?></a> &nbsp; &nbsp;
        <?php endforeach ?>
        <?php endif ?>
    </li>
    <li> Generated on:
        <?php if(is_null($provisioner_info_generated)):?>
            No provisioned
        <?php else: ?>
            <?= $provisioner_info_generated ?>
        <?php endif ?>
    </li>
    </ul>

    <legend>Provision files</legend>
    <?php if($provisioner_info_files_count == 0):?>
        No provisioned files
    <?php else: ?>
        <?php $tcols_max = 2; $tcoli=0; ?>
        <table>
            <tr>
            <?php foreach($provisioner_info_files as $fn): ?>
                <?php if($tcoli < $tcols_max): ?>
                    <?php $tcoli++; ?>
                    <td><a href="<?=$provisioner_info_url.'/'.$fn['filename']?>"><?=$fn['filename']?></a></td>
                <?php else: ?>
                    <?php $tcoli=0; ?>
                    </tr><tr>
                <?php endif ?>
            <?php endforeach ?>
            </tr>
        </table>
    <?php endif ?>

    </fieldset>
    </div>

<br />
    <div style="clear:both;"></div>
    <div class="widget" syle="float:right;" >
    <?php // new/edit registration form
                ?>
    <?php if($homepage['form_new_registration']): ?>
        <?= $this->Form->create($new_registration) ?>
        <fieldset>
            <legend>Edit Registration</legend>
            <?php
                // $phone_id_selected = $this->request->getQuery('phone_id_selected');
                echo $this->Form->hidden('__form', ['default' => 'new_registration']);
                echo $this->Form->hidden('phone_id', ['default' => $view_phone['id']]);
                echo $this->Form->hidden('registration_id', ['default' => $new_registration['id']]);
                echo $this->Form->control('line_enabled', ['options' => ['on','off']]);
                echo $this->Form->control('line_index', [ 'options' => [1,2,3]]);
                echo $this->Form->control('display_name');
                echo $this->Form->control('username');
                echo $this->Form->control('passwrd');
                echo $this->Form->control('auth_name');
                echo $this->Form->control('server_host');
                echo $this->Form->control('server_port');
                echo $this->Form->control('server_expires');
                echo $this->Form->control('server_host_backup');
                echo $this->Form->control('server_port_backup');
                echo $this->Form->control('server_expires_backup');
                echo $this->Form->control('use_outbound_proxy');
                echo $this->Form->control('outbound_host');
                echo $this->Form->control('outbound_port');
                echo $this->Form->control('outbound_host_backup');
                echo $this->Form->control('outbound_port_backup');
                echo $this->Form->control('use_stun_server');
                echo $this->Form->control('stun_server_host');
                echo $this->Form->control('stun_server_port');
                echo $this->Form->control('transport_protocol', ['options' => ['UDP','TCP']]);
                echo $this->Form->control('nat_transversal', ['options'=>['DISABLED','ENABLED']]);
                echo $this->Form->control('rport_enable',['options'=>['TRUE','FALSE']]);
                echo $this->Form->control('udp_keepalive_enable',['options'=>['TRUE','FALSE']]);
                echo $this->Form->control('udp_keepalive_seconds');
                echo $this->Form->control('sip_retry_timer');
                echo $this->Form->control('prefer_audio_codec_1');
                echo $this->Form->control('prefer_audio_codec_2');
                echo $this->Form->control('prefer_audio_codec_3');
                echo $this->Form->control('appearances');
            ?>
        </fieldset>
        <div class="button-container">
            <?= $this->Form->button(__('Submit')) ?>
        </div>
        <?= $this->Form->end() ?>

    <?php // view phone registration table
                    ?>
    <?php else: ?>
            <fieldset>
                <legend>Registrations</legend>
                <div class="button-container">
                    <?= $this->Form->postLink('Add a new registration', null,
                    [ 'data' => [ '__next_form'=>'new_registration', 'action' => 'provisioner']]) ?>
                </div>
                <?php if($view_registration_count == 0) : ?>
                    <br />
                    No registrations found
                <?php else: ?>
                    <table cellpadding="0" cellspacing="0">
                    <thead>
                    <tr>
                    <th scope="col"><?= $this->Paginator->sort('line_index') ?></th>
                    <th scope="col"><?= $this->Paginator->sort('display_name') ?></th>
                    <th scope="col"><?= $this->Paginator->sort('server_host') ?></th>
                    <th scope="col" class="actions"><?= __('Actions') ?></th>
                    </tr>
                    </thead>
                    <tbody>

                        <?php foreach($view_registrations as $view_registration): ?>
                                <tr>
                        <td><?= h($view_registration->line_index) ?> </td>
                        <td><?= h($view_registration->display_name) ?></td>
                        <td><?= h($view_registration->server_host) ?></td>

                        <td class="actions">
                        <?= $this->Form->postLink(__('Edit'), null,
                                [ 'data' => [ '__next_form'=>'new_registration', 'registration_id' => $view_registration['id'], 'action' => 'provisioner']]) ?>
                                &nbsp;&nbsp;
                        <?= $this->Form->postLink(__('Delete'), ['controller'=>'pages','action'=> 'deleteRegistration'] , ['data' => [ 'registration_id' => $view_registration['id']], 'confirm' => 'Are you sure you want to delete line: '.$view_registration['line_index'].'?']) ?>
                                        </td>
                                    </tr>
                        <?php endforeach; ?>
                                </tbody>
                    </table>
                    <div class="paginator">
                        <ul class="pagination">
                            <?= $this->Paginator->first('<< ' . __('first')) ?>
                            <?= $this->Paginator->prev('< ' . __('previous')) ?>
                            <?= $this->Paginator->numbers() ?>
                            <?= $this->Paginator->next(__('next') . ' >') ?>
                            <?= $this->Paginator->last(__('last') . ' >>') ?>
                        </ul>
                    </div>
            </fieldset>
        <?php endif ?>
    <?php endif; ?>
    </div>
<?php endif; ?>
