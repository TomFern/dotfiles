<?php
namespace App\Command;

use Cake\Console\Arguments;
use Cake\Console\Command;
use Cake\Console\ConsoleIo;
use Cake\Console\ConsoleOptionParser;
use Cake\Controller\Component;

use Cake\Core\Configure;

require_once(ROOT.DS.'src'.DS.'Lib'.DS.'ProvisionerTasks.php');

class ProvisionerCommand extends Command
{
    public function initialize()
    {
        parent::initialize();
        $this->loadModel('Provisioners');
        $this->loadModel('Registrations');
        $this->loadModel('Phones');
        $this->loadModel('Timezones');
        $this->loadModel('Brandmodels');
    }

    protected function buildOptionParser(ConsoleOptionParser $parser)
    {
        $parser->addArgument('action', [
            'help' => 'Action to take'
        ]);
        $parser->addArgument('phone_id', [
            'help' => 'phone_id'
        ]);
        return $parser;
    }

    public function execute(Arguments $args, ConsoleIo $io)
    {
        $action = $args->getArgument('action');
        $phone_id = $args->getArgument('phone_id');

        $phone = $this->Phones->get($phone_id);
        if(empty($phone)) {
            $io->out(":: Phone id not found $phone_id");
        }
        else {
            if($action == 'mk') {
                delete_endpoint($phone,$this->Provisioners);
                make_endpoint($phone,$this->Brandmodels,$this->Timezones,$this->Registrations,$this->Provisioners);
            }
            else if($action == 'rm') {
                delete_endpoint($phone,$this->Provisioners);
            }
        }
    }

}
