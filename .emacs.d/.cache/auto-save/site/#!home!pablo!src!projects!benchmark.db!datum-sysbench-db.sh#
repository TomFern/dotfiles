#!/usr/bin/env bash

# SQL statistics:
#     queries performed:
#         read:                            0
#         write:                           20379
#         other:                           0
#         total:                           20379
#     transactions:                        20379  (2033.54 per sec.)
#     queries:                             20379  (2033.54 per sec.)
#     ignored errors:                      0      (0.00 per sec.)
#     reconnects:                          0      (0.00 per sec.)

# General statistics:
#     total time:                          10.0092s
#     total number of events:              20379

# Latency (ms):
#          min:                                    0.13
#          avg:                                    0.48
#          max:                                   30.62
#          95th percentile:                        1.18
#          sum:                                 9851.25

# Threads fairness:
#     events (avg/stddev):           20379.0000/0.00
#     execution time (avg/stddev):   9.8512/0.00

# end_row=$1

function_grep.pl join_by { local IFS="$1"; shift; echo "$*"; }

function print_sqlite {
    columns=$1
    values=$2
    echo "PRAGMA foreign_keys=ON;"
    echo "insert into datum_sysbench_db ("$(join_by , ${columns[@]})") values ("$(join_by , ${values[@]})");"
}

words=($(
awk -F '[ /][ /]*' ' 
    /Number of threads:/ {print "threads " $4}
    /read:/ {print "sql_read " $3}
    /write:/ {print "sql_write " $3}
    /other:/ {print "sql_other " $3}
    /total:/ {print "sql_total " $3}
    /transactions:/ {print "sql_transactions " $3}
    /queries:/ {print "sql_queries " $3}
    /ignored errors:/ {print "sql_ignored_errors " $4}
    /reconnects:/ {print "sql_reconnects " $3}
    /total time:/ {gsub("s","",$4); print "total_time " $4}
    /total number of events:/ {print "total_events " $6}
    /min:/ {print "latency_min " $3}
    /avg:/ {print "latency_avg " $3}
    /max:/ {print "latency_max " $3}
    /95th percentile:/ {print "latency_95 " $4}
    /sum:/ {print "latency_sum " $3}
    /execution time/ {print "fair_time_avg " $6}
    /execution time/ {print "fair_time_std " $7}
    /events / {print "fair_events_avg " $5}
    /events / {print "fair_events_std " $6}
'
))

now=$(date "+%Y-%m-%dT%H:%M:%S")

# split columns vs values ...
columns=()
values=()

columns+=('datum_ts')
values+=("'$now'")

# ... from stdin
i=-1
for w in "${words[@]}"
do
    i=$((i+1))
    if [ $((i%2)) -eq 0 ]; then
        columns+=($w)
    else
        values+=("'"$w"'")
    fi
done

# ... from script arguments
i=-1
for w in "$@"
do
    i=$((i+1))
    if [ $((i%2)) -eq 0 ]; then
        columns+=($w)
    else
        values+=("'"$w"'")
    fi
done



# output formatted strings
print_sqlite $columns $values
